<!doctype html>
<meta charset="utf-8"/>
<title>ffmpeg wasm UMD test</title>
<pre id="log">Loading UMD…</pre>
<script src="/libs/ffmpeg.min.js"></script>
<script>
  const out = (m)=>{ const el=document.getElementById('log'); el.textContent += "\n"+m; console.log(m); };

  out("iso: "+window.crossOriginIsolated);
  out("global FFmpegWASM: "+(typeof window.FFmpegWASM));
  if(!window.FFmpegWASM || !window.FFmpegWASM.FFmpeg){
    out("❌ UMD global no disponible"); throw new Error("UMD missing");
  }

  const ffmpeg = new window.FFmpegWASM.FFmpeg();
  out("instancia creada. Cargando core…");
  ffmpeg.load({ corePath: "/libs/ffmpeg-core.js", log: true })
    .then(async ()=>{
      out("✅ load ok (UMD)");
      // 1s de silencio → MP3
      await ffmpeg.exec(['-f','lavfi','-i','anullsrc=r=44100:cl=mono','-t','1','out.mp3']);
      const mp3 = await ffmpeg.readFile('out.mp3');
      out("✅ transcode ok, bytes: "+(mp3 && mp3.length));

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([mp3], {type:'audio/mpeg'}));
      a.download = 'test.mp3';
      a.textContent = 'Download test.mp3';
      document.body.appendChild(a);
    })
    .catch(e=>{ out("❌ error: "+(e && e.message || e)); console.error(e); });
</script>
