<!doctype html>
<meta charset="utf-8"/>
<title>ffmpeg wasm UMD smoke test</title>
<pre id="log">Loading UMD…</pre>
<script src="/libs/ffmpeg.min.js"></script>
<script>
  const out = (m)=>{ const el=document.getElementById('log'); el.textContent += '\n'+m; console.log(m); };

  // UMD build exposes global "FFmpegWASM" with class "FFmpeg"
  out('iso: ' + window.crossOriginIsolated);
  out('global FFmpegWASM: ' + typeof window.FFmpegWASM);

  if (!window.FFmpegWASM || !window.FFmpegWASM.FFmpeg) {
    out('❌ UMD global no disponible');
  } else {
    (async () => {
      try {
        const { FFmpeg } = window.FFmpegWASM;
        const ffmpeg = new FFmpeg();

        out('Cargando core…');
        console.time('ffmpeg.load');
        await ffmpeg.load({
          corePath: '/libs/ffmpeg-core.js',       // usa nuestros archivos locales
        });
        console.timeEnd('ffmpeg.load');
        out('✅ core cargado');

        out('Ejecutando -version…');
        await ffmpeg.exec(['-version']);
        out('✅ exec ok');

        out('Generando 1s de silencio MP3…');
        await ffmpeg.exec(['-f','lavfi','-i','anullsrc=r=44100:cl=mono','-t','1','out.mp3']);
        const mp3 = await ffmpeg.readFile('out.mp3');
        out('✅ transcode ok, bytes: ' + mp3.length);
        const blob = new Blob([mp3], { type: 'audio/mpeg' });
        const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'test.mp3' });
        a.textContent = 'Download test.mp3';
        document.body.appendChild(a);
      } catch (e) {
        out('❌ error: ' + (e && e.message ? e.message : e));
        console.error(e);
      }
    })();
  }
</script>
